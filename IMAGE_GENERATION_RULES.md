# 🎨 画像生成ルール - 完全ガイド

**最終更新**: 2025-10-02
**バージョン**: 2.0
**重要度**: ⚠️ **CRITICAL** - すべての画像生成はこのルールに従う

---

## 📌 **基本原則（絶対遵守）**

### 1️⃣ **キャラクターとテーマの完全一致**
> **最重要**: 記述されたキャラクターとテーマを100%一致させる

#### ✅ 正しい例
- 「舞妓」と記述 → **舞妓（人間の女性）** を生成
- 「カエル」と記述 → **カエル（動物）** を生成
- 「招き猫」と記述 → **招き猫（猫の置物）** を生成

#### ❌ 禁止事項
- 「舞妓」→ カエルを生成（キャラクター置換）
- 「カエル」→ 人間を生成（種類の変更）
- 記述にない要素を追加

---

## 🎯 **実装箇所**

### ファイル: `api/generate-image.js`

#### **プロンプト構成** (L41-109)
```
⚠️⚠️⚠️ ABSOLUTELY CRITICAL - HIGHEST PRIORITY ⚠️⚠️⚠️

1. CHARACTER IDENTITY（キャラクター同一性）
   - 記述を3回読んでから生成開始
   - キャラクタータイプは神聖 - 絶対に変更しない
   - 例: 「舞妓」→ 人間女性、「カエル」→ カエル

2. EVERY DETAIL MUST MATCH（すべての詳細を一致）
   - 体の色、服装、アクセサリー、目、口、背景すべて一致

3. COMPOSITION（構図）
   - キャラクターサイズ: 40-45%
   - 余白: 最低40%（全方向）
   - 背景: 白（#FFFFFF）

4. STYLE（スタイル）
   - 日本のアニメ/マンガ風
   - Tシャツ向きの鮮やかな色
   - テキストなし
```

#### **品質パラメータ** (L120-121)
```javascript
num_inference_steps: 50   // 品質（28→50: 78%向上）
guidance_scale: 7.5       // プロンプト従順度（3.5→7.5: 2倍向上）
```

---

## 📏 **詳細ルール**

### **キャラクター記述** (`api/generate-ideas.js`)

#### 必須記述要素（80-150文字）
1. **何のキャラクター/モチーフか**を最初に明記
2. **主要な特徴**（形、サイズ、構造）
3. **色**（すべてのパーツ）
4. **顔・表情**（目、口、耳など）
5. **装飾・小物**（日本文化要素を含む）
6. **テーマとの関連性**

#### ✅ 良い例
```
舞妓。水色の着物を着て、赤い和傘を持つ。
着物には白い桜の模様。顔は白塗り、赤い口紅。
黒髪にはピンクの大きなかんざし。少し微笑んでいる表情。
傘は内側が金色。
```

#### ❌ 悪い例
```
舞妓。着物を着ている。（具体性不足）
```

---

## 🔧 **技術仕様**

### **画像サイズ**
- 生成: `square_hd` (1024x1024px)
- 最終出力: 4500x5400px (Canvas合成後)

### **品質設定**
| パラメータ | 値 | 理由 |
|-----------|-----|------|
| `guidance_scale` | 7.5 | プロンプトへの高い従順度 |
| `num_inference_steps` | 50 | 高品質・シャープな画像 |
| `enable_safety_checker` | false | 日本文化要素の誤検知防止 |

---

## 🚨 **トラブルシューティング**

### 問題: キャラクターが一致しない
**原因**: guidance_scaleが低い
**解決**: 7.5以上に設定（現在: 7.5）

### 問題: 画質が悪い
**原因**: num_inference_stepsが少ない
**解決**: 50以上に設定（現在: 50）

### 問題: 記述を無視する
**原因**: プロンプトの強調不足
**解決**: キャラクタータイプを複数回繰り返す（実装済み）

---

## ✅ **チェックリスト**

画像生成前に以下を確認：

- [ ] キャラクター記述が80-150文字
- [ ] キャラクタータイプが明確（人間/動物/物）
- [ ] すべてのパーツの色を記載
- [ ] 装飾・小物を具体的に記載
- [ ] テーマとの関連性が明確

画像生成後に以下を確認：

- [ ] キャラクタータイプが一致
- [ ] 色が一致
- [ ] 服装・アクセサリーが一致
- [ ] 画質が高い（シャープ、詳細）
- [ ] 構図が適切（切れていない）

---

## 📞 **エスカレーション**

以下の場合は即座に修正が必要：

1. ⚠️ **Critical**: キャラクタータイプが不一致（舞妓→カエル）
2. ⚠️ **High**: 画質が悪い（ぼやけ、低解像度）
3. ⚠️ **Medium**: 色が不一致
4. ⚠️ **Low**: 小物が不一致

---

## 📝 **変更履歴**

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-10-02 | 2.1 | 開発・運用ルール追加（変更時の必須手順、セキュリティルール、デプロイ確認） |
| 2025-10-02 | 2.0 | guidance_scale 7.5、num_inference_steps 50、プロンプト強化 |
| 2025-10-02 | 1.1 | キャラクタータイプ例を追加 |
| 2025-10-02 | 1.0 | 初版作成 |

---

## 🔧 **開発・運用ルール**

### **1. 変更時の必須手順**
⚠️ **絶対遵守**: コード変更時は必ず以下の手順を実行

```bash
# 1. 変更をステージング
git add [変更したファイル]

# 2. コミット（意味のあるメッセージで）
git commit -m "変更内容の説明"

# 3. リモートにプッシュ
git push origin main

# 4. デプロイ確認（自動デプロイ完了を待つ）
vercel ls | head -30
```

#### ❌ 禁止事項
- ローカルのみで変更を保持（必ずプッシュ）
- コミットせずに次の変更を開始
- デプロイ確認せずに作業完了とする

### **2. セキュリティルール**
⚠️ **CRITICAL**: セキュリティは最優先事項

#### ✅ 必ず守ること

1. **APIキーの保護**
   - `.env`ファイルは**絶対にGitにコミットしない**
   - `.gitignore`に`.env`が含まれていることを確認
   - APIキーをコードに直接書かない
   - 環境変数から読み込む（`process.env.XXX_API_KEY`）

2. **環境変数の管理**
   - Vercelの環境変数設定を使用
   - ローカル開発: `.env`ファイル
   - 本番環境: Vercel Dashboard → Settings → Environment Variables

3. **機密情報の扱い**
   - ログに機密情報を出力しない
   - エラーメッセージにAPIキーを含めない
   - スクリーンショットに機密情報を含めない

4. **コードレビュー**
   - コミット前に`.env`ファイルが含まれていないか確認
   - `git status`で確認
   - 疑わしい場合は`git diff`で内容確認

#### ❌ 絶対禁止

- ❌ `.env`ファイルをGitにコミット
- ❌ APIキーをコードに直接記述
- ❌ APIキーをログ出力
- ❌ APIキーを他人と共有
- ❌ `.env`ファイルをSlack/メール等で送信

#### 🚨 万が一APIキーが漏洩した場合

1. **即座にAPIキーを無効化**
   - 各サービスの管理画面で即座に削除
   - FAL AI: https://fal.ai/dashboard/keys
   - Gemini: https://aistudio.google.com/apikey
   - Printify: https://printify.com/app/account/api
   - remove.bg: https://www.remove.bg/api

2. **新しいAPIキーを発行**
   - 各サービスで新規発行

3. **Vercel環境変数を更新**
   - 新しいキーに置き換え
   - Redeploy実行

4. **報告**
   - チーム/管理者に報告

### **3. デプロイ確認チェックリスト**

変更後は必ず以下を確認：

- [ ] `git push`完了
- [ ] Vercelで自動デプロイが開始された
- [ ] デプロイが「● Ready」になった
- [ ] 本番環境（https://design-generator-puce.vercel.app）で動作確認
- [ ] エラーが発生していないか確認

---

**このドキュメントはすべての画像生成の基準です。**
**すべての修正・改善はこのルールに準拠する必要があります。**
**開発・運用ルールは例外なく遵守してください。**

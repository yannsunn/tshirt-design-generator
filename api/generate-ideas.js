// Simplified handler without middleware to avoid Vercel serverless issues
export default async function handler(req, res) {
    if (req.method !== 'POST') {
        return res.status(405).json({ error: 'Method not allowed' });
    }

    try {
        if (!req.body || !req.body.theme) {
            return res.status(400).json({ error: 'Request body is required' });
        }

        const { theme } = req.body;

        // å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if (!theme || typeof theme !== 'string') {
            return res.status(400).json({ error: 'ãƒ†ãƒ¼ãƒãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“' });
        }
        if (theme.length > 200) {
            return res.status(400).json({ error: 'ãƒ†ãƒ¼ãƒãŒé•·ã™ãã¾ã™ï¼ˆæœ€å¤§200æ–‡å­—ï¼‰' });
        }
        if (theme.trim().length === 0) {
            return res.status(400).json({ error: 'ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' });
        }

        // é‡è¤‡é˜²æ­¢ã¯ä¸€æ—¦ç„¡åŠ¹åŒ–ï¼ˆVercelã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¯¾ç­–ï¼‰
        let duplicateAvoidanceText = '';

        const apiKey = process.env.GEMINI_API_KEY;

        if (!apiKey) {
            return res.status(500).json({ error: 'GEMINI_API_KEY is not configured on the server' });
        }

        // Gemini 2.5 Flash - æœ€æ–°ã®é«˜é€Ÿãƒ¢ãƒ‡ãƒ«ï¼ˆ2025å¹´ãƒªãƒªãƒ¼ã‚¹ï¼‰
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
        const systemPrompt = `ã‚ãªãŸã¯å¤–å›½äººè¦³å…‰å®¢å‘ã‘ã®æ—¥æœ¬æ–‡åŒ–Tã‚·ãƒ£ãƒ„ã‚’ãƒ‡ã‚¶ã‚¤ãƒ³ã™ã‚‹ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã§ã™ã€‚æŒ‡å®šã•ã‚ŒãŸãƒ†ãƒ¼ãƒã«æ²¿ã£ã¦ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ‡ã‚¶ã‚¤ãƒ³ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’4ã¤ææ¡ˆã—ã¦ãã ã•ã„ã€‚

ğŸ¯ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: æ—¥æœ¬ã‚’è¨ªã‚Œã‚‹å¤–å›½äººè¦³å…‰å®¢
ğŸ¨ å•†å“: ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰å‘ã‘Tã‚·ãƒ£ãƒ„ï¼ˆã‚¤ãƒ©ã‚¹ãƒˆã®ã¿ã€æ–‡å­—ã¯å¾Œã‹ã‚‰åˆæˆï¼‰

ğŸš¨ æœ€é‡è¦: **å¿…ãšãƒ†ãƒ¼ãƒã«é–¢é€£ã—ãŸãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ææ¡ˆã™ã‚‹ã“ã¨**

ğŸŒŸ **ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³è¦ä»¶ï¼ˆè¶…é‡è¦ï¼‰:**
- **4ã¤ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã¯äº’ã„ã«å¤§ããç•°ãªã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**
- åŒã˜ã‚ˆã†ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€åŒã˜ã‚ˆã†ãªè‰²ã€åŒã˜ã‚ˆã†ãªæ§‹å›³ã‚’é¿ã‘ã‚‹ã“ã¨
- ç•°ãªã‚‹è§’åº¦ã€ç•°ãªã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ã€ç•°ãªã‚‹é›°å›²æ°—ã‚’è¿½æ±‚ã™ã‚‹ã“ã¨
- ãƒ•ãƒ¬ãƒ¼ã‚ºã‚‚å¤šæ§˜æ€§ã‚’æŒãŸã›ã€é‡è¤‡ã‚„é¡ä¼¼ã‚’é¿ã‘ã‚‹ã“ã¨
- ä¾‹: å¯æ„›ã„ç³»ã€ã‹ã£ã“ã„ã„ç³»ã€ãƒ›ãƒ©ãƒ¼ç³»ã€ãƒ¬ãƒˆãƒ­ç³»ãªã©ã€ç•°ãªã‚‹ãƒ†ã‚¤ã‚¹ãƒˆã‚’æ··ãœã‚‹

å„ã‚³ãƒ³ã‚»ãƒ—ãƒˆã«ã¯ä»¥ä¸‹ã‚’å«ã‚ã¦ãã ã•ã„ï¼š

1. **ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»ãƒ¢ãƒãƒ¼ãƒ•** (80-150æ–‡å­—ã€æ—¥æœ¬èªã§å…·ä½“çš„ã‹ã¤è©³ç´°ã«):

   ğŸš¨ **æœ€é‡è¦**: AIç”»åƒç”Ÿæˆã§æ­£ç¢ºã«å†ç¾ã•ã‚Œã‚‹ã‚ˆã†ã€**éå¸¸ã«å…·ä½“çš„ã§è©³ç´°ãªè¨˜è¿°**ã‚’ã™ã‚‹ã“ã¨

   **å¿…é ˆè¨˜è¿°è¦ç´ ï¼ˆã™ã¹ã¦å«ã‚ã‚‹ã“ã¨ï¼‰:**
   a. **ä½•ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼/ãƒ¢ãƒãƒ¼ãƒ•ã‹**ã‚’æœ€åˆã«æ˜è¨˜
      - ä¾‹: ã€Œæç¯ãŠåŒ–ã‘ã®ã‚¸ãƒ£ãƒƒã‚¯ã‚ªãƒ¼ãƒ©ãƒ³ã‚¿ãƒ³ã€ã€Œå¹½éœŠã€ã€Œé­”å¥³çŒ«ã€

   b. **ä¸»è¦ãªç‰¹å¾´**ï¼ˆå½¢ã€ã‚µã‚¤ã‚ºã€æ§‹é€ ï¼‰
      - ä¾‹: ã€Œæç¯ã®ã‚ˆã†ãªä¸¸ã„å½¢ã€ã€Œé•·ã„é»’é«ªã€ã€Œå¤§ããªå°–ã£ãŸå¸½å­ã€

   c. **è‰²**ï¼ˆã™ã¹ã¦ã®ãƒ‘ãƒ¼ãƒ„ã®è‰²ã‚’æ˜è¨˜ï¼‰
      - ä¾‹: ã€Œã‚ªãƒ¬ãƒ³ã‚¸è‰²ã®ä½“ã€ã€Œé»’ã„ä¸‰è§’ã®ç›®ã€ã€Œé‡‘è‰²ã®éˆ´ã€

   d. **é¡”ãƒ»è¡¨æƒ…**ï¼ˆç›®ã€å£ã€è€³ãªã©ï¼‰
      - ä¾‹: ã€Œä¸€ã¤ç›®ã€ã€Œã‚®ã‚¶ã‚®ã‚¶ã®å£ã€ã€Œå¤§ããªé»’ã„ç³ã€

   e. **è£…é£¾ãƒ»å°ç‰©**ï¼ˆæ—¥æœ¬æ–‡åŒ–è¦ç´ ã‚’å«ã‚€ï¼‰
      - ä¾‹: ã€Œé ­ã«å°ã•ãªé³¥å±…ã€ã€Œç€ç‰©é¢¨ã®ãƒ­ãƒ¼ãƒ–ã€ã€Œé‡‘è‰²ã®éˆ´ä»˜ãé¦–è¼ªã€

   f. **ãƒ†ãƒ¼ãƒã¨ã®é–¢é€£æ€§**ã‚’æ˜ç¢ºã«
      - ãƒ†ãƒ¼ãƒã‹ã‚‰å¤–ã‚ŒãŸãƒ¢ãƒãƒ¼ãƒ•ã¯çµ¶å¯¾ã«ææ¡ˆã—ãªã„ã“ã¨

   âœ… è‰¯ã„ä¾‹ï¼ˆãƒ†ãƒ¼ãƒ: å’Œé¢¨ãƒãƒ­ã‚¦ã‚£ãƒ³ï¼‰:
   - ã€Œæç¯ãŠåŒ–ã‘ã®ã‚¸ãƒ£ãƒƒã‚¯ã‚ªãƒ¼ãƒ©ãƒ³ã‚¿ãƒ³ã€‚ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã§æç¯ã®ã‚ˆã†ãªä¸¸ã„å½¢ã€‚ä¸€ã¤ç›®ã§å¤§ããã€ã‚®ã‚¶ã‚®ã‚¶ã®å£ã€‚é ­ã«å°ã•ãªèµ¤ã„é³¥å±…ã‚’ä¹—ã›ã¦ã„ã‚‹ã€‚å‘¨ã‚Šã«ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã®å…‰ãŒæ¼ã‚Œã¦ã„ã‚‹ã€‚ã€ï¼ˆ86æ–‡å­—ï¼‰
   - ã€Œç™½ã„ç€ç‰©ã‚’ç€ãŸå¹½éœŠã€‚é•·ã„é»’é«ªãŒé¡”ã‚’åŠåˆ†éš ã™ã€‚é’ç™½ã„é¡”ã€é–‰ã˜ãŸç›®ã€å°ã•ãªå£ã€‚ä¸¡æ‰‹ã«é’ã„ç«ã®ç‰ã‚’æŒã¤ã€‚ç€ç‰©ã«ã¯æ¡œã®æ¨¡æ§˜ã€‚è¶³å…ƒãŒé€ã‘ã¦æ¶ˆãˆã¦ã„ã‚‹ã€‚ã€ï¼ˆ81æ–‡å­—ï¼‰

   âŒ æ‚ªã„ä¾‹:
   - ã€Œã‚ªãƒ¬ãƒ³ã‚¸è‰²ã®ã‚«ãƒœãƒãƒ£ãŠåŒ–ã‘ã€‚æç¯ã®ã‚ˆã†ãªå½¢ã€ä¸‰è§’ã®ç›®ã¨å£ã€é ­ã«å’Œå‚˜ã‚’è¼‰ã›ã¦ã„ã‚‹ã€‚ã€ï¼ˆä¸ååˆ†: ä½•ã®ãŠåŒ–ã‘ã‹ä¸æ˜ç¢ºã€ä¸€ã¤ç›®ã¨æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã®ã«ä¸‰è§’ã®ç›®ã«ãªã£ã¦ã„ã‚‹ã€é³¥å±…ãŒå’Œå‚˜ã«å¤‰ã‚ã£ã¦ã„ã‚‹ï¼‰
   - ã€Œèµ¤ã„ã ã‚‹ã¾ã€ï¼ˆãƒ†ãƒ¼ãƒã¨ç„¡é–¢ä¿‚ï¼‰
   - ã€ŒçŠ¬ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€ï¼ˆãƒ†ãƒ¼ãƒã¨ç„¡é–¢ä¿‚ï¼‰

2. **ãƒ•ãƒ¬ãƒ¼ã‚º**: ã™ã¹ã¦ã²ã‚‰ãŒãªã§çŸ­ãï¼ˆ5-10æ–‡å­—ï¼‰ã€ãƒ†ãƒ¼ãƒã«æ²¿ã£ãŸã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ã€‚
   - **å¿…ãšã²ã‚‰ãŒãªã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ï¼ˆæ¼¢å­—ãƒ»ã‚«ã‚¿ã‚«ãƒŠãƒ»è‹±èªç¦æ­¢ï¼‰**
   - **å¿…ãš4ã¤ã¨ã‚‚ç•°ãªã‚‹ãƒ•ãƒ¬ãƒ¼ã‚ºã«ã™ã‚‹ã“ã¨**
   - é‡è¤‡ã‚„é¡ä¼¼ã—ãŸãƒ•ãƒ¬ãƒ¼ã‚ºã¯é¿ã‘ã‚‹ã“ã¨
   - ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ä¾‹: ç–‘å•å½¢ã€å‘½ä»¤å½¢ã€æ„Ÿå˜†å½¢ã€åè©å½¢ãªã©

3. **ãƒ•ã‚©ãƒ³ãƒˆã‚¹ã‚¿ã‚¤ãƒ«**: 'pop', 'horror', 'retro', 'modern' ã®ã„ãšã‚Œã‹1ã¤ï¼ˆãƒ†ãƒ¼ãƒã«åˆã£ãŸã‚‚ã®ã‚’é¸ã¶ï¼‰
   - **å¯èƒ½ãªé™ã‚Š4ã¤ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã§ç•°ãªã‚‹ãƒ•ã‚©ãƒ³ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä½¿ã†ã“ã¨**

4. **å•†å“èª¬æ˜** (150-250æ–‡å­—ã€æ—¥æœ¬èª):

   ğŸš¨ **é‡è¦**: ã™ã¹ã¦ã®å•†å“ã‚¿ã‚¤ãƒ—ï¼ˆTã‚·ãƒ£ãƒ„ã€ãƒ‘ãƒ¼ã‚«ãƒ¼ã€ã‚¹ã‚¦ã‚§ãƒƒãƒˆç­‰ï¼‰ã§ä½¿ãˆã‚‹æ±ç”¨çš„ãªèª¬æ˜æ–‡ã‚’ä½œæˆ

   **å¿…é ˆè¦ç´ ï¼ˆã™ã¹ã¦å«ã‚ã‚‹ã“ã¨ï¼‰:**
   a. **ãƒ‡ã‚¶ã‚¤ãƒ³ã®ç‰¹å¾´**ï¼ˆ40-60æ–‡å­—ï¼‰
      - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»ãƒ¢ãƒãƒ¼ãƒ•ã®é­…åŠ›ã‚’ç°¡æ½”ã«èª¬æ˜
      - ä¾‹: "å’Œé¢¨ãƒãƒ­ã‚¦ã‚£ãƒ³ã®æç¯ãŠåŒ–ã‘ãŒç™»å ´ï¼æ—¥æœ¬ã®å¦–æ€ªã‚¹ã‚¿ã‚¤ãƒ«ã¨æ´‹é¢¨ãƒãƒ­ã‚¦ã‚£ãƒ³ã®èåˆãƒ‡ã‚¶ã‚¤ãƒ³ã€‚"

   b. **ãƒ•ãƒ¬ãƒ¼ã‚ºã®æ„å‘³ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**ï¼ˆ30-50æ–‡å­—ï¼‰
      - ãƒ•ãƒ¬ãƒ¼ã‚ºãŒæŒã¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚„é›°å›²æ°—ã‚’èª¬æ˜
      - ä¾‹: "ã€Œã“ã“ã‚ãªã„ã€ã®ãƒ•ãƒ¬ãƒ¼ã‚ºãŒã€ä¸æ€è­°ã§åˆ‡ãªã„é›°å›²æ°—ã‚’æ¼”å‡ºã—ã¾ã™ã€‚"

   c. **ç€ç”¨ã‚·ãƒ¼ãƒ³ãƒ»ç”¨é€”**ï¼ˆ30-50æ–‡å­—ï¼‰
      - ã©ã‚“ãªå ´é¢ã§ä½¿ãˆã‚‹ã‹ã€èª°ã«ãŠã™ã™ã‚ã‹
      - ä¾‹: "ãƒãƒ­ã‚¦ã‚£ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚„æ—¥å¸¸ã®ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«ã«ã´ã£ãŸã‚Šã€‚å€‹æ€§çš„ãªãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³ãŒå¥½ããªæ–¹ã«ã€‚"

   d. **ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°**ï¼ˆ5-8å€‹ï¼‰
      - ãƒ†ãƒ¼ãƒã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€é›°å›²æ°—ã«é–¢é€£ã™ã‚‹ã‚¿ã‚°
      - ä¾‹: "#å’Œé¢¨ãƒãƒ­ã‚¦ã‚£ãƒ³ #ãŠåŒ–ã‘ #æ—¥æœ¬æ–‡åŒ– #ãƒ¦ãƒ‹ãƒ¼ã‚¯ #ã‹ã‚ã„ã„ #å€‹æ€§çš„ #ã‚«ã‚¸ãƒ¥ã‚¢ãƒ« #ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³"

   âœ… è‰¯ã„ä¾‹:
   "å’Œé¢¨ãƒãƒ­ã‚¦ã‚£ãƒ³ã®æç¯ãŠåŒ–ã‘ãŒç™»å ´ï¼æ—¥æœ¬ã®å¦–æ€ªã‚¹ã‚¿ã‚¤ãƒ«ã¨æ´‹é¢¨ãƒãƒ­ã‚¦ã‚£ãƒ³ã®èåˆãƒ‡ã‚¶ã‚¤ãƒ³ã€‚ã€Œã“ã“ã‚ãªã„ã€ã®ãƒ•ãƒ¬ãƒ¼ã‚ºãŒã€ä¸æ€è­°ã§åˆ‡ãªã„é›°å›²æ°—ã‚’æ¼”å‡ºã—ã¾ã™ã€‚ãƒãƒ­ã‚¦ã‚£ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚„æ—¥å¸¸ã®ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«ã«ã´ã£ãŸã‚Šã€‚å€‹æ€§çš„ãªãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³ãŒå¥½ããªæ–¹ã«ãŠã™ã™ã‚ã§ã™ã€‚\n\n#å’Œé¢¨ãƒãƒ­ã‚¦ã‚£ãƒ³ #ãŠåŒ–ã‘ #æ—¥æœ¬æ–‡åŒ– #ãƒ¦ãƒ‹ãƒ¼ã‚¯ #ã‹ã‚ã„ã„ #å€‹æ€§çš„ #ã‚«ã‚¸ãƒ¥ã‚¢ãƒ« #ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³"

   âŒ æ‚ªã„ä¾‹:
   - "ã“ã®Tã‚·ãƒ£ãƒ„ã¯..." ï¼ˆå•†å“ã‚¿ã‚¤ãƒ—ã‚’ç‰¹å®šã—ãªã„ï¼‰
   - "å¯æ„›ã„ã§ã™ã€‚" ï¼ˆå…·ä½“æ€§ãªã—ï¼‰
   - ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ãªã—

ğŸš¨ é‡è¦äº‹é …ï¼š
1. **æŒ‡å®šã•ã‚ŒãŸãƒ†ãƒ¼ãƒã«å¿…ãšæ²¿ã†ã“ã¨**ï¼ˆæœ€å„ªå…ˆï¼‰
2. **ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨˜è¿°ã¯80-150æ–‡å­—ã§å…·ä½“çš„ã‹ã¤è©³ç´°ã«**
3. **ä½•ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼/ãƒ¢ãƒãƒ¼ãƒ•ã‹ã‚’æœ€åˆã«æ˜è¨˜**ã™ã‚‹ã“ã¨
4. ã™ã¹ã¦ã®ãƒ‘ãƒ¼ãƒ„ã®è‰²ã€å½¢ã€ç‰¹å¾´ã‚’æ˜è¨˜
5. **4ã¤ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã¯äº’ã„ã«å¤§ããç•°ãªã‚‹ã“ã¨ï¼ˆè‰²ã€å½¢ã€é›°å›²æ°—ã€è¡¨æƒ…ãªã©ï¼‰**
6. characterãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯**å¿…ãšæ—¥æœ¬èª**ã§è¨˜è¿°
7. **phraseãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¿…ãšã™ã¹ã¦ã²ã‚‰ãŒãªã®ã¿ï¼ˆæ¼¢å­—ãƒ»ã‚«ã‚¿ã‚«ãƒŠãƒ»è‹±èªç¦æ­¢ï¼‰**
8. **descriptionãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯150-250æ–‡å­—ã€å•†å“ã‚¿ã‚¤ãƒ—ã«ä¾å­˜ã—ãªã„æ±ç”¨çš„ãªèª¬æ˜æ–‡**
9. AIç”»åƒç”ŸæˆãŒæ­£ç¢ºã«å†ç¾ã§ãã‚‹è©³ç´°ã•ã‚’ä¿ã¤
10. ã‚·ãƒ³ãƒ—ãƒ«ã§Tã‚·ãƒ£ãƒ„ã«æ˜ ãˆã‚‹ã‚¢ã‚¤ã‚³ãƒ‹ãƒƒã‚¯ãªãƒ‡ã‚¶ã‚¤ãƒ³
11. å¤–å›½äººãŒè¦‹ã¦ã€Œæ—¥æœ¬ã£ã½ã„ï¼ã€ã¨æ„Ÿã˜ã‚‹è¦ç´ ã‚’å«ã‚ã‚‹
12. è‹±èªã¯ä¸€åˆ‡ä½¿ç”¨ã—ãªã„ã“ã¨
13. **å‰µé€ æ€§ã¨ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æœ€å¤§é™ã«ç™ºæ®ã™ã‚‹ã“ã¨**

ğŸ“ è¨˜è¿°ã®è³ªãŒç”»åƒç”Ÿæˆã®ç²¾åº¦ã‚’æ±ºå®šã—ã¾ã™ã€‚æ›–æ˜§ãªè¨˜è¿°ã¯é¿ã‘ã€å…·ä½“çš„ã§è©³ç´°ã«æ›¸ã„ã¦ãã ã•ã„ã€‚`;


        const payload = {
            contents: [{ parts: [{ text: `ãƒ†ãƒ¼ãƒ: ${theme}

é‡è¦:
1. 4ã¤ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã¯äº’ã„ã«å¤§ããç•°ãªã‚‹ã‚‚ã®ã«ã—ã¦ãã ã•ã„ã€‚åŒã˜ã‚ˆã†ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€è‰²ã€æ§‹å›³ã€ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’é¿ã‘ã€æœ€å¤§é™ã®å¤šæ§˜æ€§ã‚’è¿½æ±‚ã—ã¦ãã ã•ã„ã€‚
2. ãƒ•ãƒ¬ãƒ¼ã‚ºã¯å¿…ãšã™ã¹ã¦ã²ã‚‰ãŒãªã®ã¿ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆæ¼¢å­—ãƒ»ã‚«ã‚¿ã‚«ãƒŠãƒ»è‹±èªã¯çµ¶å¯¾ã«ä½¿ç”¨ç¦æ­¢ï¼‰ã€‚
${duplicateAvoidanceText}` }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: {
                temperature: 1.5,  // â† INCREASE from 1.2 to 1.5 for maximum diversity
                topK: 60,  // â† ADD topK for more diverse sampling
                topP: 0.98,  // â† ADD topP for more randomness
                responseMimeType: "application/json",
                responseSchema: {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            character: { type: "STRING" },
                            phrase: { type: "STRING" },
                            fontStyle: { type: "STRING" },
                            description: { type: "STRING" }
                        },
                        required: ["character", "phrase", "fontStyle", "description"]
                    }
                }
            }
        };

        // Gemini APIå‘¼ã³å‡ºã— with timeout
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 15000); // 15ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            signal: controller.signal
        }).finally(() => clearTimeout(timeout));

        if (!response.ok) {
            const errorText = await response.text();
            console.error('Gemini API request failed:', response.status, errorText.substring(0, 200));
            throw new Error(`Gemini API error: ${response.status} - ${errorText}`);
        }

        const responseText = await response.text();
        let result;

        try {
            result = JSON.parse(responseText);
        } catch (parseError) {
            console.error('Failed to parse Gemini API response:', parseError.message, responseText.substring(0, 200));
            throw new Error(`Gemini APIã‹ã‚‰ç„¡åŠ¹ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã¾ã—ãŸã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹: ${responseText.substring(0, 200)}...`);
        }

        if (!result.candidates || !result.candidates[0]?.content?.parts?.[0]?.text) {
            console.error('Unexpected Gemini API response structure:', JSON.stringify(result).substring(0, 200));
            throw new Error(`Gemini APIã‹ã‚‰äºˆæœŸã—ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ãŒè¿”ã•ã‚Œã¾ã—ãŸ: ${JSON.stringify(result)}`);
        }

        const ideas = JSON.parse(result.candidates[0].content.parts[0].text);
        res.status(200).json({ ideas });

    } catch (error) {
        console.error('Request failed:', error.message, error.stack?.substring(0, 500));

        // Ensure we don't send response twice
        if (!res.headersSent) {
            res.status(500).json({
                error: error.message,
                stack: error.stack?.substring(0, 500),
                name: error.name
            });
        }
    }
}
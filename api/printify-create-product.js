// Printify APIçµ±åˆ - å•†å“ä½œæˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
export default async function handler(req, res) {
    if (req.method !== 'POST') {
        return res.status(405).json({ error: 'Method not allowed' });
    }

    try {
        const { shopId, imageId, title, description, tags } = req.body;
        const apiKey = process.env.PRINTIFY_API_KEY;

        if (!apiKey) {
            return res.status(500).json({ error: 'PRINTIFY_API_KEY is not configured' });
        }

        if (!shopId || !imageId) {
            return res.status(400).json({ error: 'shopId and imageId are required' });
        }

        // Printifyå•†å“ä½œæˆ
        // Blueprint ID: 6 = Gildan 5000 (ãƒ™ãƒ¼ã‚·ãƒƒã‚¯Tã‚·ãƒ£ãƒ„)
        // Print Provider: 3 = MyLocker (å®‰å®šã—ãŸãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼)
        const blueprintId = 6;
        const printProviderId = 3;

        // 1. ã¾ãšåˆ©ç”¨å¯èƒ½ãªvariantsã‚’å–å¾—
        const variantsResponse = await fetch(
            `https://api.printify.com/v1/catalog/blueprints/${blueprintId}/print_providers/${printProviderId}/variants.json`,
            {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                }
            }
        );

        if (!variantsResponse.ok) {
            const errorText = await variantsResponse.text();
            throw new Error(`Printify Variants API error: ${variantsResponse.status} - ${errorText}`);
        }

        const variantsData = await variantsResponse.json();
        console.log(`Total variants available: ${variantsData.variants?.length}`);
        if (variantsData.variants?.length > 0) {
            console.log('Sample variant structure:', JSON.stringify(variantsData.variants[0], null, 2));
        }

        // æ³¨æ„: Printifyã¯å•†å“ä½œæˆå¾Œã«è‡ªå‹•çš„ã«ãƒ¢ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ç”Ÿæˆã—ã¾ã™
        // APIçµŒç”±ã§ã®ãƒ¢ãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®šã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãŸã‚ã€
        // Printify Webãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ¢ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ãã ã•ã„
        console.log('Mockups will be auto-generated by Printify after product creation');

        // åˆ©ç”¨å¯èƒ½ãªvariantã‹ã‚‰è‰²Ã—ã‚µã‚¤ã‚ºã®çµ„ã¿åˆã‚ã›ã‚’æŠ½å‡º
        const availableVariants = variantsData.variants || [];
        const selectedVariants = [];
        const variantIds = [];

        // ã‚µã‚¤ã‚ºå„ªå…ˆé †ä½ï¼ˆS, M, L, XL, 2XLï¼‰
        const sizePreference = ['S', 'M', 'L', 'XL', '2XL'];

        // è‰²ã®å„ªå…ˆé †ä½ï¼ˆåˆè¨ˆ7è‰²ï¼‰
        // 1. Whiteï¼ˆç™½ï¼‰- å¿…é ˆ
        // 2. Blackï¼ˆé»’ï¼‰- å¿…é ˆ
        // 3-4. Whiteç³»ï¼ˆAsh, Natural, etc.ï¼‰
        // 5-6. Black/Darkç³»ï¼ˆDark Heather, Charcoal, etc.ï¼‰
        // 7. Grayç³»
        const colorPriority = [
            { keywords: ['WHITE'], priority: 1, name: 'White' },
            { keywords: ['BLACK'], priority: 1, name: 'Black' },
            { keywords: ['ASH', 'NATURAL', 'CREAM', 'SAND'], priority: 2, name: 'Light' },
            { keywords: ['DARK HEATHER', 'CHARCOAL', 'NAVY'], priority: 3, name: 'Dark' },
            { keywords: ['GRAY', 'GREY', 'SPORT GREY', 'HEATHER'], priority: 4, name: 'Gray' },
        ];

        // è‰²ã”ã¨ã«ãƒãƒªã‚¢ãƒ³ãƒˆã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const colorGroups = new Map();

        // Debug: Log first few variant titles to understand format
        console.log('Sample variant titles:', availableVariants.slice(0, 5).map(v => v.title));

        for (const variant of availableVariants) {
            if (!variant.title) continue;

            const upperTitle = variant.title.toUpperCase();

            // ã‚µã‚¤ã‚ºã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆã•ã‚‰ã«æŸ”è»Ÿãªãƒãƒƒãƒãƒ³ã‚°ï¼‰
            const matchedSize = sizePreference.find(size => {
                // "S / White", "S/White", "White / S", "Small", etc.
                const patterns = [
                    ` ${size} `,
                    `/${size}/`,
                    ` ${size}/`,
                    `/${size} `,
                    `\t${size}\t`,
                    `\t${size} `,
                    ` ${size}\t`
                ];
                return patterns.some(pattern => upperTitle.includes(pattern)) ||
                       upperTitle.startsWith(`${size} `) ||
                       upperTitle.startsWith(`${size}/`) ||
                       upperTitle.endsWith(` ${size}`) ||
                       upperTitle.endsWith(`/${size}`);
            });

            // If size check is too strict, skip it for now - just get all variants
            // We'll filter by size later if needed

            // è‰²ã‚’åˆ¤å®šï¼ˆã‚ˆã‚ŠæŸ”è»Ÿã«ï¼‰
            let matchedColor = null;
            for (const colorDef of colorPriority) {
                if (colorDef.keywords.some(keyword => upperTitle.includes(keyword))) {
                    matchedColor = colorDef;
                    break;
                }
            }

            // If no color matched but variant exists, assign to "Other" group
            if (!matchedColor) {
                matchedColor = { name: 'Other', priority: 5, keywords: [] };
            }

            const colorKey = matchedColor.name;
            if (!colorGroups.has(colorKey)) {
                colorGroups.set(colorKey, {
                    priority: matchedColor.priority,
                    name: colorKey,
                    variants: []
                });
            }

            colorGroups.get(colorKey).variants.push(variant);
        }

        console.log('Color groups after matching:', Array.from(colorGroups.keys()));

        // å„ªå…ˆé †ä½é †ã«ä¸¦ã¹æ›¿ãˆ
        const sortedColors = Array.from(colorGroups.values()).sort((a, b) => a.priority - b.priority);

        console.log('Available color groups:', sortedColors.map(c => `${c.name} (${c.variants.length} variants)`));

        // æœ€å¤§7è‰²ã€å„è‰²ã§å…¨ã‚µã‚¤ã‚ºã‚’é¸æŠ
        const maxColors = 7;
        for (let i = 0; i < Math.min(maxColors, sortedColors.length); i++) {
            const colorGroup = sortedColors[i];
            console.log(`Selecting color group: ${colorGroup.name}`);

            for (const variant of colorGroup.variants) {
                selectedVariants.push({
                    id: variant.id,
                    price: 2500, // åŸºæœ¬ä¾¡æ ¼2500å††
                    is_enabled: true
                });
                variantIds.push(variant.id);
            }
        }

        console.log(`Total variants selected: ${selectedVariants.length}`);
        console.log('Sample selected variants:', selectedVariants.slice(0, 3).map(v => {
            const fullVariant = availableVariants.find(av => av.id === v.id);
            return fullVariant?.title || v.id;
        }));

        // variantãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æœ€åˆã®35å€‹ã‚’ä½¿ç”¨ï¼ˆ7è‰²Ã—5ã‚µã‚¤ã‚ºï¼‰
        if (selectedVariants.length === 0) {
            console.warn('No variants matched criteria, using first 35 variants');
            for (let i = 0; i < Math.min(35, availableVariants.length); i++) {
                selectedVariants.push({
                    id: availableVariants[i].id,
                    price: 2500,
                    is_enabled: true
                });
                variantIds.push(availableVariants[i].id);
            }
        }

        const printifyApiUrl = `https://api.printify.com/v1/shops/${shopId}/products.json`;

        const payload = {
            title: title || 'Custom Japanese Culture T-Shirt',
            description: description || 'AI-generated unique Japanese-themed t-shirt design. Perfect souvenir for tourists visiting Japan.',
            blueprint_id: blueprintId,
            print_provider_id: printProviderId,
            variants: selectedVariants,
            print_areas: [
                {
                    variant_ids: variantIds,
                    placeholders: [
                        {
                            position: 'front',
                            images: [
                                {
                                    id: imageId,
                                    x: 0.5, // Center horizontal
                                    y: 0.45, // Slightly above center for better appearance
                                    scale: 0.95, // 95% size to prevent cropping
                                    angle: 0
                                }
                            ]
                        }
                    ]
                }
            ],
            // Note: Printify APIã§ã¯mockupsã¯å•†å“ä½œæˆå¾Œã«åˆ¥é€”è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹
            // ã“ã“ã§ã¯åŸºæœ¬çš„ãªå•†å“æ§‹é€ ã®ã¿ã‚’ä½œæˆ
            tags: tags || ['Japanese Culture', 'AI Generated', 'Custom Design', 'Tourist Souvenir'],
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ‰ãƒ©ãƒ•ãƒˆã¨ã—ã¦ä½œæˆï¼ˆå¾Œã§ç¢ºèªã—ã¦ã‹ã‚‰å…¬é–‹ï¼‰
            is_locked: false
        };

        const response = await fetch(printifyApiUrl, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Printify Product Creation error: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        const productId = result.id;

        console.log('Product created successfully:', productId);
        console.log('Printify will auto-generate mockups for this product');

        // è‰²ã‚°ãƒ«ãƒ¼ãƒ—ã®è©³ç´°æƒ…å ±ã‚’ä½œæˆ
        const actualColorsUsed = sortedColors.slice(0, Math.min(maxColors, sortedColors.length));
        const selectedColorNames = actualColorsUsed.map(c => c.name).join(', ') || 'Default selection';
        const actualColorCount = actualColorsUsed.length || Math.ceil(selectedVariants.length / 5);
        const estimatedSizesPerColor = actualColorCount > 0 ? Math.floor(selectedVariants.length / actualColorCount) : 5;

        res.status(200).json({
            productId: productId,
            productUrl: `https://printify.com/app/products/${productId}`,
            message: `âœ… Product created successfully!

ğŸ“¦ Product Details:
â€¢ ${selectedVariants.length} variants created
â€¢ Color groups: ${actualColorCount} (${selectedColorNames})
â€¢ Approx. ${estimatedSizesPerColor} sizes per color
â€¢ Design positioned at center (y=0.45, scale=0.95)
â€¢ Price: Â¥2,500 per item
â€¢ English title & description for international reach

âš ï¸ Mockups:
Printify automatically generates mockups after product creation.
Visit the product page to view and customize mockups.

ğŸ¯ Next Steps:
1. Visit Printify dashboard to review product
2. Check mockups in "Edit design" section (auto-generated)
3. Verify all color/size combinations are correct
4. Customize mockups if needed ("View all mockups" shows 50+ options)
5. Publish to your store when ready

Product URL: https://printify.com/app/products/${productId}`
        });

    } catch (error) {
        console.error('Error in /api/printify-create-product:', error);
        res.status(500).json({ error: error.message });
    }
}